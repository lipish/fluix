# TextInput 文本选择宽度跳动问题修复

## 问题描述

在 TextInput 组件中选择部分文本时，整个文本的宽度会发生变化，导致视觉上的"跳动"效果。

### 问题现象
- **未选择文本时**：文本宽度正常
- **选择部分文本后**：文本宽度发生变化，文本看起来在"移动"
- **取消选择后**：宽度恢复正常

## 根本原因

原始实现中：
- **无选择时**：文本直接作为子元素渲染（`.child(text)`）
- **有选择时**：选中的文本被包裹在一个带背景色的 `div()` 中（`.bg(rgb(0x4A90E2))`）

这种不一致的渲染方式导致：
1. 选中文本的 `div` 可能有不同的布局计算方式
2. `div` 容器可能引入额外的间距或对齐差异
3. 文本直接渲染与包裹在容器中的渲染，在 GPUI 中的宽度计算不同

## 解决方案

采用**绝对定位的背景层**方案：

### 核心思路
1. **统一文本渲染**：所有文本都以相同方式渲染，不再分割成多个部分
2. **分离背景层**：使用绝对定位的层来显示选中效果和光标
3. **不影响布局**：绝对定位的层不参与 flex 布局计算

### 实现细节

```rust
// 使用相对定位的容器
div()
    .flex()
    .flex_row()
    .items_center()
    .w_full()
    .relative()
    .child(
        // 主文本层 - 始终以相同方式渲染完整文本
        div()
            .text_color(rgb(0x333333))
            .child(full_display_text)
    )
    .when(has_selection, |this| {
        // 选中背景层 - 绝对定位，不影响布局
        this.child(
            div()
                .absolute()
                .top(px(0.))
                .left(px(0.))
                .flex()
                .flex_row()
                .items_center()
                .child(
                    // 选中前的透明占位
                    div()
                        .opacity(0.)
                        .child(text_before_sel)
                )
                .child(
                    // 选中背景
                    div()
                        .bg(rgb(0x4A90E2))
                        .text_color(rgb(0xFFFFFF))
                        .child(selected_text)
                )
        )
    })
    .when(!has_selection, |this| {
        // 光标层 - 绝对定位，不影响布局
        this.child(
            div()
                .absolute()
                .top(px(0.))
                .left(px(0.))
                .flex()
                .flex_row()
                .items_center()
                .child(
                    // 光标前的透明占位
                    div()
                        .opacity(0.)
                        .when(!text_before_cursor.is_empty(), |this| {
                            this.child(text_before_cursor)
                        })
                )
                .child(
                    // 光标
                    div()
                        .w(px(1.))
                        .h(px(18.))
                        .bg(rgb(0x333333))
                )
        )
    })
```

### 关键点

1. **主文本层**：
   - 始终渲染完整的文本
   - 保持固定的布局和宽度
   - 不受选择状态影响

2. **背景层**：
   - 使用 `.absolute()` 绝对定位
   - 使用 `.opacity(0.)` 创建透明占位文本来定位选中区域
   - 背景层覆盖在主文本层之上

3. **透明占位**：
   - 使用与主文本相同的内容渲染（但透明）
   - 确保选中背景精确对齐到正确的字符位置

## 测试方法

运行示例程序测试：

```bash
cargo run --example text_input_cursor_demo
```

### 测试要点

1. **输入文本**：在输入框中输入多个字符
2. **文本选择**：使用 Shift + 方向键选择部分文本
3. **观察宽度**：确认文本宽度在选择前后保持不变
4. **验证选中效果**：选中文本应该正确高亮显示
5. **密码模式**：在密码输入框中测试相同功能

### 预期结果

- ✅ 文本宽度在选择前后保持不变
- ✅ 选中文本正确高亮显示（蓝色背景，白色文字）
- ✅ 光标位置正确显示
- ✅ 密码模式下功能正常

## 修改文件

- `src/components/form/text_input.rs` (第 523-641 行)

## 相关功能

- 文本选择（Shift + 方向键）
- 全选（Cmd/Ctrl + A）
- 光标移动（方向键）
- 密码输入模式

## 注意事项

1. 此方案依赖于 GPUI 的绝对定位功能
2. 透明占位文本必须与主文本使用相同的渲染方式，以确保精确对齐
3. 在密码模式下，需要确保占位文本也使用相同数量的遮罩字符（"•"）

## 后续优化可能性

1. 考虑使用 Canvas 绘制选中背景（如果 GPUI 支持）
2. 添加选中动画效果
3. 支持自定义选中背景颜色
4. 优化性能（减少重复渲染）
